<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>승무소 관리 시스템</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <div id="root"></div>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://srsyxsddjbojnwvjoera.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyc3l4c2RkamJvam53dmpvZXJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3NjY4NTEsImV4cCI6MjA3NDM0Mjg1MX0.wmTrMzDqBs10qL_wBeJJQTjQMuCuvfAmY6_eW2brqT8';

        function App() {
            const [isAuth, setIsAuth] = useState(false);
            const [officeName, setOfficeName] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [officeInfo, setOfficeInfo] = useState(null);
            const [dias, setDias] = useState([]);
            const [tab, setTab] = useState('office');
            const [diaTypeTab, setDiaTypeTab] = useState('all');
            const [editing, setEditing] = useState(null);
            const [search, setSearch] = useState('');
            const [loading, setLoading] = useState(false);
            const [offices, setOffices] = useState([]);
            const [loadingOffices, setLoadingOffices] = useState(true);

            // 승무소 목록 로드
            useEffect(() => {
                loadOfficeList();
            }, []);

            const loadOfficeList = async () => {
                setLoadingOffices(true);
                try {
                    const res = await fetch(
                        `${SUPABASE_URL}/rest/v1/office?select=office_name&order=office_name`,
                        { 
                            headers: { 
                                'apikey': SUPABASE_ANON_KEY, 
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}` 
                            } 
                        }
                    );
                    const data = await res.json();
                    if (Array.isArray(data)) {
                        setOffices(data.map(o => o.office_name));
                    }
                } catch (e) {
                    console.error('승무소 목록 로드 오류:', e);
                } finally {
                    setLoadingOffices(false);
                }
            };

            const login = async () => {
                setError('');
                setLoading(true);
                try {
                    const res = await fetch(`${SUPABASE_URL}/functions/v1/authenticate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'apikey': SUPABASE_ANON_KEY
                        },
                        body: JSON.stringify({ office_name: officeName, password })
                    });
                    const data = await res.json();
                    if (data.success) {
                        setIsAuth(true);
                        await loadData();
                    } else {
                        setError('승무소 이름 또는 비밀번호가 일치하지 않습니다.');
                    }
                } catch (e) {
                    setError('인증 오류: ' + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const loadData = async () => {
                setLoading(true);
                try {
                    const officeRes = await fetch(
                        `${SUPABASE_URL}/rest/v1/office?office_name=eq.${encodeURIComponent(officeName)}&select=*`,
                        { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                    );
                    const officeData = await officeRes.json();

                    if (officeData?.[0]) {
                        const office = officeData[0];

                        const parsePostgresArray = (value) => {
                            if (!value) return [];
                            if (Array.isArray(value)) return value;
                            if (typeof value === 'string') {
                                return value
                                    .replace(/^\{/, '')
                                    .replace(/\}$/, '')
                                    .split(',')
                                    .map(s => s.trim())
                                    .filter(Boolean);
                            }
                            return [];
                        };

                        office.dia_turns1 = parsePostgresArray(office.dia_turns1);
                        office.dia_turns2 = parsePostgresArray(office.dia_turns2);
                        office.dia_turns3 = parsePostgresArray(office.dia_turns3);
                        office.sub_turns = parsePostgresArray(office.sub_turns);
                        office.dia_selects = parsePostgresArray(office.dia_selects);

                        setOfficeInfo(office);
                    }

                    const diaRes = await fetch(
                        `${SUPABASE_URL}/rest/v1/dia?office_name=eq.${encodeURIComponent(officeName)}&select=*&order=id`,
                        { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                    );
                    const diaData = await diaRes.json();
                    setDias(diaData || []);
                } catch (e) {
                    alert('데이터 로드 오류: ' + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const saveOffice = async (item) => {
                setLoading(true);
                try {
                    const updateData = {};

                    if (item.editField === 'office_code') {
                        updateData.office_code = item.office_code;
                    } else if (item.editField === 'dia_turns1') {
                        const values = typeof item.dia_turns1 === 'string'
                            ? item.dia_turns1.split(',').map(s => s.trim()).filter(Boolean)
                            : item.dia_turns1;
                        updateData.dia_turns1 = `{${values.join(',')}}`;
                    } else if (item.editField === 'dia_turns2') {
                        const values = typeof item.dia_turns2 === 'string'
                            ? item.dia_turns2.split(',').map(s => s.trim()).filter(Boolean)
                            : item.dia_turns2;
                        updateData.dia_turns2 = `{${values.join(',')}}`;
                    } else if (item.editField === 'dia_turns3') {
                        const values = typeof item.dia_turns3 === 'string'
                            ? item.dia_turns3.split(',').map(s => s.trim()).filter(Boolean)
                            : item.dia_turns3;
                        updateData.dia_turns3 = `{${values.join(',')}}`;
                    } else if (item.editField === 'sub_turns') {
                        const values = typeof item.sub_turns === 'string'
                            ? item.sub_turns.split(',').map(s => s.trim()).filter(Boolean)
                            : item.sub_turns;
                        updateData.sub_turns = `{${values.join(',')}}`;
                    } else if (item.editField === 'dia_selects') {
                        const values = typeof item.dia_selects === 'string'
                            ? item.dia_selects.split(',').map(s => s.trim()).filter(Boolean)
                            : item.dia_selects;
                        updateData.dia_selects = `{${values.join(',')}}`;
                    }

                    const res = await fetch(
                        `${SUPABASE_URL}/rest/v1/office?office_name=eq.${encodeURIComponent(officeName)}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify(updateData)
                        }
                    );

                    if (res.ok) {
                        alert('저장 완료!');
                        setEditing(null);
                        await loadData();
                    } else {
                        const errorText = await res.text();
                        alert('저장 실패: ' + errorText);
                    }
                } catch (e) {
                    alert('오류: ' + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const saveDia = async (item) => {
                setLoading(true);
                try {
                    const diaData = {
                        dia_id: item.dia_id,
                        type_name: item.type_name,
                        work_time: item.work_time || '',
                        first_time: item.first_time || '',
                        second_time: item.second_time || '',
                        third_time: item.third_time || '',
                        total_time: item.total_time || '',
                        num_tr1: item.num_tr1 || '',
                        num_tr2: item.num_tr2 || '',
                        office_name: officeName,
                        office_id: officeInfo.office_id
                    };

                    let res;
                    if (item.id) {
                        res = await fetch(
                            `${SUPABASE_URL}/rest/v1/dia?id=eq.${item.id}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Prefer': 'return=minimal'
                                },
                                body: JSON.stringify(diaData)
                            }
                        );
                    } else {
                        res = await fetch(
                            `${SUPABASE_URL}/rest/v1/dia`,
                            {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Prefer': 'return=minimal'
                                },
                                body: JSON.stringify(diaData)
                            }
                        );
                    }

                    if (res.ok) {
                        alert(item.id ? '수정 완료!' : '추가 완료!');
                        setEditing(null);
                        await loadData();
                    } else {
                        const errorText = await res.text();
                        alert('실패: ' + errorText);
                    }
                } catch (e) {
                    alert('오류: ' + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const deleteDia = async (id) => {
                if (!confirm('삭제하시겠습니까?')) return;
                setLoading(true);
                try {
                    const res = await fetch(
                        `${SUPABASE_URL}/rest/v1/dia?id=eq.${id}`,
                        {
                            method: 'DELETE',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Prefer': 'return=minimal'
                            }
                        }
                    );

                    if (res.ok) {
                        alert('삭제 완료!');
                        await loadData();
                    } else {
                        const errorText = await res.text();
                        alert('삭제 실패: ' + errorText);
                    }
                } catch (e) {
                    alert('오류: ' + e.message);
                } finally {
                    setLoading(false);
                }
            };

            if (!isAuth) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">승무소 Dia관리 시스템</h1>
                                <p className="text-gray-600">승무소별로 편하게 수정하세요</p>
                            </div>

                            {error && (
                                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                    {error}
                                </div>
                            )}

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">승무소 선택</label>
                                    {loadingOffices ? (
                                        <div className="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                                            승무소 목록 로딩 중...
                                        </div>
                                    ) : (
                                        <select
                                            value={officeName}
                                            onChange={(e) => setOfficeName(e.target.value)}
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white"
                                        >
                                            <option value="">승무소를 선택하세요</option>
                                            {offices.map(office => (
                                                <option key={office} value={office}>
                                                    {office}
                                                </option>
                                            ))}
                                        </select>
                                    )}
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">비밀번호(문의:02b2min2@kakao.com)</label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && login()}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        placeholder="••••••••"
                                    />
                                </div>
                                <button
                                    onClick={login}
                                    disabled={loading || !officeName || !password}
                                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition shadow-lg"
                                >
                                    {loading ? '인증 중...' : '로그인'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            const naturalSort = (a, b) => {
                const aDiaId = a.dia_id || '';
                const bDiaId = b.dia_id || '';

                const splitId = (str) => {
                    const match = str.match(/^([가-힣]*)(\d+)$/);
                    if (match) {
                        return { text: match[1], num: parseInt(match[2], 10) };
                    }
                    const numMatch = str.match(/^(\d+)$/);
                    if (numMatch) {
                        return { text: '', num: parseInt(numMatch[1], 10) };
                    }
                    return { text: str, num: 0 };
                };

                const aParts = splitId(aDiaId);
                const bParts = splitId(bDiaId);

                if (aParts.text !== bParts.text) {
                    if (!aParts.text) return -1;
                    if (!bParts.text) return 1;
                    return aParts.text.localeCompare(bParts.text);
                }

                return aParts.num - bParts.num;
            };

            const diaTypes = ['all', ...new Set(dias.map(d => d.type_name).filter(Boolean))];
            const filteredByType = diaTypeTab === 'all'
                ? dias
                : dias.filter(d => d.type_name === diaTypeTab);
            const filteredDias = filteredByType
                .filter(d => d.dia_id?.toLowerCase().includes(search.toLowerCase()))
                .sort(naturalSort);

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white shadow border-b">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">{officeName}</h1>
                                <p className="text-sm text-gray-500">데이터 관리</p>
                            </div>
                            <button
                                onClick={() => { setIsAuth(false); setOfficeName(''); setPassword(''); }}
                                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm"
                            >
                                로그아웃
                            </button>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 py-6">
                        <div className="bg-white rounded-lg shadow-lg">
                            <div className="flex border-b">
                                <button
                                    onClick={() => setTab('office')}
                                    className={`px-6 py-4 font-medium ${tab === 'office' ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-50'}`}
                                >
                                    승무소 정보
                                </button>
                                <button
                                    onClick={() => setTab('dia')}
                                    className={`px-6 py-4 font-medium ${tab === 'dia' ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50' : 'text-gray-600 hover:bg-gray-50'}`}
                                >
                                    다이아 관리 ({dias.length})
                                </button>
                            </div>

                            {tab === 'office' && officeInfo && (
                                <div className="p-6">
                                    <h2 className="text-xl font-semibold mb-6">승무소 기본 정보</h2>

                                    <div className="space-y-4">
                                        <div className="p-4 bg-gray-50 rounded-lg">
                                            <p className="text-sm text-gray-600 mb-1">승무소명</p>
                                            <p className="text-lg font-semibold">{officeInfo.office_name}</p>
                                        </div>

                                        <div className="p-4 bg-white border rounded-lg flex justify-between items-start">
                                            <div className="flex-1">
                                                <p className="text-sm text-gray-600 mb-1">기관사</p>
                                                <p className="text-sm font-medium text-gray-800">
                                                    {Array.isArray(officeInfo.dia_turns1) && officeInfo.dia_turns1.length > 0
                                                        ? officeInfo.dia_turns1.join(', ')
                                                        : '-'}
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => setEditing({ ...officeInfo, editField: 'dia_turns1' })}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm ml-4"
                                            >
                                                수정
                                            </button>
                                        </div>

                                        <div className="p-4 bg-white border rounded-lg flex justify-between items-start">
                                            <div className="flex-1">
                                                <p className="text-sm text-gray-600 mb-1">차장</p>
                                                <p className="text-sm font-medium text-gray-800">
                                                    {Array.isArray(officeInfo.dia_turns2) && officeInfo.dia_turns2.length > 0
                                                        ? officeInfo.dia_turns2.join(', ')
                                                        : '-'}
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => setEditing({ ...officeInfo, editField: 'dia_turns2' })}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm ml-4"
                                            >
                                                수정
                                            </button>
                                        </div>

                                        <div className="p-4 bg-white border rounded-lg flex justify-between items-start">
                                            <div className="flex-1">
                                                <p className="text-sm text-gray-600 mb-1">운휴</p>
                                                <p className="text-sm font-medium text-gray-800">
                                                    {Array.isArray(officeInfo.dia_turns3) && officeInfo.dia_turns3.length > 0
                                                        ? officeInfo.dia_turns3.join(', ')
                                                        : '-'}
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => setEditing({ ...officeInfo, editField: 'dia_turns3' })}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm ml-4"
                                            >
                                                수정
                                            </button>
                                        </div>

                                        <div className="p-4 bg-white border rounded-lg flex justify-between items-start">
                                            <div className="flex-1">
                                                <p className="text-sm text-gray-600 mb-1">4조2교대(예비)</p>
                                                <p className="text-sm font-medium text-gray-800">
                                                    {Array.isArray(officeInfo.sub_turns) && officeInfo.sub_turns.length > 0
                                                        ? officeInfo.sub_turns.join(', ')
                                                        : '-'}
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => setEditing({ ...officeInfo, editField: 'sub_turns' })}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm ml-4"
                                            >
                                                수정
                                            </button>
                                        </div>

                                        <div className="p-4 bg-white border rounded-lg flex justify-between items-start">
                                            <div className="flex-1">
                                                <p className="text-sm text-gray-600 mb-1">교번선택</p>
                                                <p className="text-sm font-medium text-gray-800">
                                                    {Array.isArray(officeInfo.dia_selects) && officeInfo.dia_selects.length > 0
                                                        ? officeInfo.dia_selects.join(', ')
                                                        : '-'}
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => setEditing({ ...officeInfo, editField: 'dia_selects' })}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm ml-4"
                                            >
                                                수정
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {tab === 'dia' && (
                                <div>
                                    <div className="border-b bg-gray-50 px-2 md:px-4 pt-4 overflow-x-auto">
                                        <div className="flex gap-2 min-w-max">
                                            {diaTypes.map(type => (
                                                <button
                                                    key={type}
                                                    onClick={() => setDiaTypeTab(type)}
                                                    className={`px-3 md:px-4 py-2 font-medium rounded-t-lg transition text-sm md:text-base whitespace-nowrap ${diaTypeTab === type
                                                        ? 'bg-white text-blue-600 border-t-2 border-blue-500'
                                                        : 'text-gray-600 hover:bg-gray-100'
                                                        }`}
                                                >
                                                    {type === 'all' ? '전체' : type}
                                                    <span className="ml-1 text-xs md:text-sm">
                                                        ({type === 'all' ? dias.length : dias.filter(d => d.type_name === type).length})
                                                    </span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="p-2 md:p-4 flex flex-col md:flex-row gap-2 md:gap-4 bg-gray-50 border-b">
                                        <input
                                            type="text"
                                            value={search}
                                            onChange={(e) => setSearch(e.target.value)}
                                            placeholder="다이아 ID로 검색..."
                                            className="flex-1 px-3 md:px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm md:text-base"
                                        />
                                        <button
                                            onClick={() => setEditing({ office_name: officeName, type_name: diaTypeTab === 'all' ? '' : diaTypeTab })}
                                            className="px-3 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 whitespace-nowrap text-sm md:text-base"
                                        >
                                            + 추가
                                        </button>
                                    </div>

                                    {filteredDias.length === 0 ? (
                                        <div className="p-4 md:p-8 text-center text-gray-500 text-sm md:text-base">
                                            등록된 다이아가 없습니다.
                                        </div>
                                    ) : (
                                        <>
                                            <div className="block md:hidden divide-y">
                                                {filteredDias.map(dia => (
                                                    <div key={dia.id} className="p-3 hover:bg-gray-50">
                                                        <div className="flex items-center justify-between mb-3">
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-bold text-lg text-gray-900">
                                                                    {dia.dia_id}
                                                                </span>
                                                                <span className="inline-block px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">
                                                                    {dia.type_name}
                                                                </span>
                                                            </div>
                                                            <div className="flex gap-1">
                                                                <button
                                                                    onClick={() => setEditing(dia)}
                                                                    className="px-3 py-1 text-xs text-blue-600 bg-blue-50 hover:bg-blue-100 rounded font-medium"
                                                                >
                                                                    수정
                                                                </button>
                                                                <button
                                                                    onClick={() => deleteDia(dia.id)}
                                                                    className="px-3 py-1 text-xs text-red-600 bg-red-50 hover:bg-red-100 rounded font-medium"
                                                                >
                                                                    삭제
                                                                </button>
                                                            </div>
                                                        </div>

                                                        <div className="bg-gray-50 rounded-lg p-2 mb-2">
                                                            <div className="flex items-center justify-between text-sm">
                                                                <div className="flex items-center gap-4">
                                                                    {dia.work_time && (
                                                                        <div>
                                                                            <span className="text-gray-500 text-xs">출근</span>
                                                                            <span className="ml-1 font-semibold text-gray-900">{dia.work_time}</span>
                                                                        </div>
                                                                    )}
                                                                    {dia.total_time && (
                                                                        <div>
                                                                            <span className="text-gray-500 text-xs">총근무</span>
                                                                            <span className="ml-1 font-semibold text-gray-900">{dia.total_time}</span>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {dia.first_time && (
                                                            <div className="bg-blue-50 rounded-lg p-2 mb-1">
                                                                <div className="flex items-center justify-between">
                                                                    <span className="text-xs font-medium text-blue-600">전반사업</span>
                                                                    <span className="font-semibold text-gray-900">{dia.first_time}</span>
                                                                </div>
                                                            </div>
                                                        )}

                                                        {dia.num_tr1 && (
                                                            <div className="bg-blue-50 rounded-lg p-2 mb-2">
                                                                <div className="flex items-center justify-between">
                                                                    <span className="text-xs font-medium text-blue-600">전반 열번</span>
                                                                    <span className="font-semibold text-gray-900">{dia.num_tr1}</span>
                                                                </div>
                                                            </div>
                                                        )}

                                                        {dia.second_time && (
                                                            <div className="bg-green-50 rounded-lg p-2 mb-1">
                                                                <div className="flex items-center justify-between">
                                                                    <span className="text-xs font-medium text-green-600">후반사업</span>
                                                                    <span className="font-semibold text-gray-900">{dia.second_time}</span>
                                                                </div>
                                                            </div>
                                                        )}

                                                        {dia.num_tr2 && (
                                                            <div className="bg-green-50 rounded-lg p-2 mb-2">
                                                                <div className="flex items-center justify-between">
                                                                    <span className="text-xs font-medium text-green-600">후반 열번</span>
                                                                    <span className="font-semibold text-gray-900">{dia.num_tr2}</span>
                                                                </div>
                                                            </div>
                                                        )}

                                                        {dia.third_time && (
                                                            <div className="bg-purple-50 rounded-lg p-2">
                                                                <div className="flex items-center justify-between">
                                                                    <span className="text-xs font-medium text-purple-600">세 번째</span>
                                                                    <span className="font-semibold text-gray-900">{dia.third_time}</span>
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>

                                            <div className="hidden md:block overflow-x-auto">
                                                <table className="w-full">
                                                    <thead className="bg-gray-100">
                                                        <tr>
                                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">다이아ID</th>
                                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">타입</th>
                                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">출근시간</th>
                                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">전반사업</th>
                                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">후반사업</th>
                                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">총근무</th>
                                                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase">관리</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y">
                                                        {filteredDias.map(dia => (
                                                            <tr key={dia.id} className="hover:bg-gray-50">
                                                                <td className="px-4 py-3 text-sm font-medium">{dia.dia_id}</td>
                                                                <td className="px-4 py-3 text-sm">
                                                                    <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium whitespace-nowrap">
                                                                        {dia.type_name}
                                                                    </span>
                                                                </td>
                                                                <td className="px-4 py-3 text-sm">{dia.work_time || '-'}</td>
                                                                <td className="px-4 py-3 text-sm">
                                                                    {dia.first_time || '-'}
                                                                    {dia.num_tr1 && <div className="text-xs text-gray-500">({dia.num_tr1})</div>}
                                                                </td>
                                                                <td className="px-4 py-3 text-sm">
                                                                    {dia.second_time || '-'}
                                                                    {dia.num_tr2 && <div className="text-xs text-gray-500">({dia.num_tr2})</div>}
                                                                </td>
                                                                <td className="px-4 py-3 text-sm">{dia.total_time || '-'}</td>
                                                                <td className="px-4 py-3 whitespace-nowrap">
                                                                    <button
                                                                        onClick={() => setEditing(dia)}
                                                                        className="px-2 py-1 text-blue-600 hover:bg-blue-50 rounded mr-2 text-sm"
                                                                    >
                                                                        수정
                                                                    </button>
                                                                    <button
                                                                        onClick={() => deleteDia(dia.id)}
                                                                        className="px-2 py-1 text-red-600 hover:bg-red-50 rounded text-sm"
                                                                    >
                                                                        삭제
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>

                    {editing && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl p-6 w-full max-w-2xl h-[85vh] md:max-h-[90vh] overflow-hidden flex flex-col">
                                <div className="flex-shrink-0 flex justify-between mb-6">
                                    <h2 className="text-2xl font-bold">
                                        {tab === 'office' && editing.editField === 'office_code' && '승무소 코드 수정'}
                                        {tab === 'office' && editing.editField === 'dia_turns1' && '기관사 수정'}
                                        {tab === 'office' && editing.editField === 'dia_turns2' && '차장 수정'}
                                        {tab === 'office' && editing.editField === 'dia_turns3' && '운휴 수정'}
                                        {tab === 'office' && editing.editField === 'sub_turns' && '4조2교대(예비) 수정'}
                                        {tab === 'office' && editing.editField === 'dia_selects' && '교번선택 수정'}
                                        {tab === 'dia' && (editing.id ? '다이아 수정' : '다이아 추가')}
                                    </h2>
                                    <button onClick={() => setEditing(null)} className="text-gray-500 hover:text-gray-700 text-2xl">
                                        ×
                                    </button>
                                </div>

                                <div className="flex-grow space-y-4 overflow-y-auto pr-2">
                                    {tab === 'office' ? (
                                        <>
                                            {editing.editField === 'office_code' && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">승무소 코드</label>
                                                    <input
                                                        placeholder="승무소 코드"
                                                        value={editing.office_code || ''}
                                                        onChange={(e) => setEditing({ ...editing, office_code: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                            )}
                                            {editing.editField === 'dia_turns1' && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">기관사 (쉼표로 구분)</label>
                                                    <textarea
                                                        placeholder="예: 1번,2번,3번"
                                                        value={Array.isArray(editing.dia_turns1) ? editing.dia_turns1.join(',') : editing.dia_turns1 || ''}
                                                        onChange={(e) => setEditing({ ...editing, dia_turns1: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                        rows="10"
                                                    />
                                                </div>
                                            )}
                                            {editing.editField === 'dia_turns2' && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">차장 (쉼표로 구분)</label>
                                                    <textarea
                                                        placeholder="예: A번,B번,C번"
                                                        value={Array.isArray(editing.dia_turns2) ? editing.dia_turns2.join(',') : editing.dia_turns2 || ''}
                                                        onChange={(e) => setEditing({ ...editing, dia_turns2: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                        rows="10"
                                                    />
                                                </div>
                                            )}
                                            {editing.editField === 'dia_turns3' && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">운휴 (쉼표로 구분)</label>
                                                    <textarea
                                                        placeholder="예: 휴무1,휴무2"
                                                        value={Array.isArray(editing.dia_turns3) ? editing.dia_turns3.join(',') : editing.dia_turns3 || ''}
                                                        onChange={(e) => setEditing({ ...editing, dia_turns3: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                        rows="10"
                                                    />
                                                </div>
                                            )}
                                            {editing.editField === 'sub_turns' && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">4조2교대(예비) (쉼표로 구분)</label>
                                                    <textarea
                                                        placeholder="예: 예비1,예비2"
                                                        value={Array.isArray(editing.sub_turns) ? editing.sub_turns.join(',') : editing.sub_turns || ''}
                                                        onChange={(e) => setEditing({ ...editing, sub_turns: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                        rows="10"
                                                    />
                                                </div>
                                            )}
                                            {editing.editField === 'dia_selects' && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">교번선택 (쉼표로 구분)</label>
                                                    <textarea
                                                        placeholder="예: 평일,주말,공휴일"
                                                        value={Array.isArray(editing.dia_selects) ? editing.dia_selects.join(',') : editing.dia_selects || ''}
                                                        onChange={(e) => setEditing({ ...editing, dia_selects: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                        rows="10"
                                                    />
                                                </div>
                                            )}
                                        </>
                                    ) : (
                                        <>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">다이아 ID *</label>
                                                    <input
                                                        placeholder="예: 대1"
                                                        value={editing.dia_id || ''}
                                                        onChange={(e) => setEditing({ ...editing, dia_id: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">타입명 *</label>
                                                    <input
                                                        placeholder="예: 평일"
                                                        value={editing.type_name || ''}
                                                        onChange={(e) => setEditing({ ...editing, type_name: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">출근시간</label>
                                                <input
                                                    placeholder="예: 05:00"
                                                    value={editing.work_time || ''}
                                                    onChange={(e) => setEditing({ ...editing, work_time: e.target.value })}
                                                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                />
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">전반사업 시간</label>
                                                    <input
                                                        placeholder="예: 05:30"
                                                        value={editing.first_time || ''}
                                                        onChange={(e) => setEditing({ ...editing, first_time: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">전반 열차번호</label>
                                                    <input
                                                        placeholder="예: 101"
                                                        value={editing.num_tr1 || ''}
                                                        onChange={(e) => setEditing({ ...editing, num_tr1: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">후반사업 시간</label>
                                                    <input
                                                        placeholder="예: 13:30"
                                                        value={editing.second_time || ''}
                                                        onChange={(e) => setEditing({ ...editing, second_time: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">후반 열차번호</label>
                                                    <input
                                                        placeholder="예: 201"
                                                        value={editing.num_tr2 || ''}
                                                        onChange={(e) => setEditing({ ...editing, num_tr2: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">총 근무시간</label>
                                                    <input
                                                        placeholder="예: 08:00"
                                                        value={editing.total_time || ''}
                                                        onChange={(e) => setEditing({ ...editing, total_time: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">세 번째 시간 (선택)</label>
                                                    <input
                                                        placeholder="예: 21:30"
                                                        value={editing.third_time || ''}
                                                        onChange={(e) => setEditing({ ...editing, third_time: e.target.value })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                                    />
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>

                                <div className="flex-shrink-0 flex gap-3 pt-4 border-t mt-4">
                                    <button
                                        onClick={() => tab === 'office' ? saveOffice(editing) : saveDia(editing)}
                                        className="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-medium"
                                    >
                                        저장
                                    </button>
                                    <button
                                        onClick={() => setEditing(null)}
                                        className="flex-1 bg-gray-200 py-3 rounded-lg hover:bg-gray-300 font-medium"
                                    >
                                        취소
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {loading && (
                        <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 shadow-xl">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                                <p className="mt-4 text-gray-700 font-medium">처리 중...</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>